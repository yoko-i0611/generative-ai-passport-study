# 再発防止対策

**作成日**: 2025-01-03  
**目的**: 新しい構造への移行時にエラーが発生しないようにする

---

## 🛡️ 対策1: 段階的な変更のチェックリスト

### 各Phaseごとに必ず確認すること

#### Phase 1: インポートの追加
- [ ] インポート文を追加
- [ ] **ビルドエラーがないか確認** (`npm run build`)
- [ ] **リンターエラーがないか確認** (`npm run lint` または IDEのリンター)
- [ ] **ブラウザで動作確認**（エラーが出ないか）
- [ ] **コミット**（`git commit -m "Phase 1: インポート追加"`）

#### Phase 2: データ構造の準備
- [ ] データ構造を定義
- [ ] **ビルドエラーがないか確認**
- [ ] **リンターエラーがないか確認**
- [ ] **ブラウザで動作確認**
- [ ] **コミット**

#### Phase 3: ロジックの追加
- [ ] useEffectやロジックを追加
- [ ] **ビルドエラーがないか確認**
- [ ] **リンターエラーがないか確認**
- [ ] **ブラウザで動作確認**
- [ ] **コミット**

#### Phase 4: レンダリングの更新
- [ ] レンダリングロジックを更新
- [ ] **ビルドエラーがないか確認**
- [ ] **リンターエラーがないか確認**
- [ ] **ブラウザで動作確認**（表示が正しいか）
- [ ] **コミット**

---

## 🔄 対策2: Gitのブランチ戦略

### 推奨ワークフロー

```bash
# 1. 新しいブランチを作成
git checkout -b feature/new-structure-chapter1

# 2. 各Phaseごとにコミット
git add app/courses/chapter1/page.tsx
git commit -m "Phase 1: インポート追加"

# 3. 動作確認後、次のPhaseへ
git add app/courses/chapter1/page.tsx
git commit -m "Phase 2: データ構造準備"

# 4. すべて完了したら、mainブランチにマージ
git checkout main
git merge feature/new-structure-chapter1
```

### メリット
- 問題が発生した場合、簡単に元に戻せる
- 各Phaseの状態を記録できる
- 他の作業に影響を与えない

---

## 🧪 対策3: 自動チェックの設定

### package.jsonにスクリプトを追加

```json
{
  "scripts": {
    "check": "npm run lint && npm run build",
    "check:watch": "npm run lint -- --watch"
  }
}
```

### 使用方法

```bash
# 変更後に必ず実行
npm run check
```

### エディタの設定（VSCode/Cursor）

`.vscode/settings.json`に以下を追加：

```json
{
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.enablePromptUseWorkspaceTsdk": true
}
```

---

## 📋 対策4: 変更前のバックアップ

### 自動バックアップスクリプト

`scripts/backup-before-change.sh`を作成：

```bash
#!/bin/bash
# 変更前にバックアップを取る

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="backups/${TIMESTAMP}"

mkdir -p "$BACKUP_DIR"

# 変更予定のファイルをバックアップ
cp app/courses/chapter1/page.tsx "$BACKUP_DIR/"
cp app/courses/chapter2/page.tsx "$BACKUP_DIR/"

echo "✅ バックアップ完了: $BACKUP_DIR"
```

### 使用方法

```bash
chmod +x scripts/backup-before-change.sh
./scripts/backup-before-change.sh
```

---

## 🔍 対策5: 変更前の状態確認

### チェックリスト

変更を始める前に：

- [ ] **現在の状態で動作確認**（正常に動作することを確認）
- [ ] **Gitの状態を確認**（`git status`）
- [ ] **未コミットの変更がないか確認**
- [ ] **ビルドが成功するか確認**（`npm run build`）
- [ ] **ブラウザで表示が正しいか確認**

---

## 📝 対策6: 変更ログの記録

### 変更ログテンプレート

`CHANGELOG_STRUCTURE_MIGRATION.md`を作成：

```markdown
# 構造変更ログ

## 変更日: 2025-01-03

### 変更内容
- [ ] Phase 1: インポート追加
- [ ] Phase 2: データ構造準備
- [ ] Phase 3: ロジック追加
- [ ] Phase 4: レンダリング更新

### 確認事項
- [ ] ビルドエラーなし
- [ ] リンターエラーなし
- [ ] ブラウザで動作確認済み

### 問題点
- （問題があれば記録）

### 解決方法
- （解決方法があれば記録）
```

---

## 🚨 対策7: エラー発生時の対応手順

### エラーが発生した場合

1. **すぐに変更を元に戻す**
   ```bash
   git checkout -- app/courses/chapter1/page.tsx
   ```

2. **ビルドキャッシュをクリア**
   ```bash
   rm -rf .next
   npm run dev
   ```

3. **エラーの原因を記録**
   - どのPhaseで発生したか
   - エラーメッセージ
   - 変更内容

4. **原因を特定してから再開**
   - エラーの原因を特定
   - 解決方法を検討
   - 再度段階的に変更

---

## 🎯 対策8: 段階的変更のテンプレート

### 変更テンプレートファイル

`TEMPLATE_STRUCTURE_MIGRATION.md`を作成し、各変更時に参照：

```markdown
# 構造変更テンプレート

## Phase 1: インポート追加
- [ ] インポート文を追加
- [ ] ビルド確認
- [ ] 動作確認
- [ ] コミット

## Phase 2: データ構造準備
- [ ] データ構造を定義
- [ ] ビルド確認
- [ ] 動作確認
- [ ] コミット

## Phase 3: ロジック追加
- [ ] ロジックを追加
- [ ] ビルド確認
- [ ] 動作確認
- [ ] コミット

## Phase 4: レンダリング更新
- [ ] レンダリングロジックを更新
- [ ] ビルド確認
- [ ] 動作確認
- [ ] コミット
```

---

## 📊 対策9: 定期的な状態確認

### 週次確認

- [ ] すべてのファイルがGitで管理されているか
- [ ] ビルドが成功するか
- [ ] リンターエラーがないか
- [ ] ブラウザで正常に表示されるか

---

## 🔧 対策10: 開発環境の整備

### 推奨ツール

1. **ESLint**: コードの品質チェック
2. **Prettier**: コードフォーマット
3. **TypeScript**: 型チェック
4. **Husky**: Gitフック（コミット前にチェック）

### 設定例

`.husky/pre-commit`:

```bash
#!/bin/sh
npm run lint
npm run build
```

---

## ✅ 実装推奨順序

1. **即座に実装可能**
   - 対策1: 段階的な変更のチェックリスト
   - 対策5: 変更前の状態確認
   - 対策7: エラー発生時の対応手順

2. **短期で実装**
   - 対策2: Gitのブランチ戦略
   - 対策4: 変更前のバックアップ
   - 対策6: 変更ログの記録

3. **中長期で実装**
   - 対策3: 自動チェックの設定
   - 対策8: 段階的変更のテンプレート
   - 対策10: 開発環境の整備

---

**最終更新**: 2025-01-03  
**状態**: 対策案作成完了


